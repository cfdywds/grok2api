# 重复图片清理指南

## 📊 扫描结果

根据最新扫描结果：
- **图片总数**: 4825 张
- **重复组数**: 1012 组
- **重复文件数**: 1012 个
- **可释放空间**: 176.77 MB

## 🎯 清理策略

工具采用智能清理策略，**优先保留有提示词的图片**：

1. **优先级1**: 保留有完整提示词的图片（非"导入:"开头）
2. **优先级2**: 保留最早创建的图片
3. **删除**: 其他重复的图片

### 示例

```
[1] 哈希: 716099085c188541... (2 个文件)
  [保留] 00730c1b-49c3-458d-af52-aef7935fce0a.jpg (有提示词)
         提示词: 性感和迷人的女孩，穿着、戴着一个透明的...
  [删除] imagine_1770648408695_2.jpg
         提示词: 导入的: imagine_1770648408695_2
```

在这个例子中，虽然两个文件时间相同，但第一个有完整的提示词，所以被保留。

## 🚀 使用方法

### 1. 试运行模式（推荐先执行）

查看将要删除的文件，但不实际删除：

```bash
python cleanup_duplicates.py
```

### 2. 执行清理

确认无误后，执行实际清理：

```bash
python cleanup_duplicates.py --clean
```

系统会要求确认：
```
[!] 警告: 即将删除重复文件！
[*] 清理策略: 优先保留有提示词的图片，其次保留最早的图片
   确认继续？(yes/no):
```

输入 `yes` 确认执行。

### 3. 为现有图片添加哈希值

如果你想为所有现有图片添加内容哈希（用于未来的去重检查）：

```bash
python cleanup_duplicates.py --add-hashes --clean
```

### 4. 指定图片目录

如果图片不在默认目录：

```bash
python cleanup_duplicates.py --image-dir /path/to/images
```

## 📋 清理流程

1. **扫描**: 计算所有图片的 SHA256 哈希值
2. **分组**: 按哈希值分组，找出重复的图片
3. **排序**: 在每组中，优先保留有提示词的图片
4. **删除**: 删除重复的文件
5. **更新**: 更新 `data/image_metadata.json` 元数据文件

## ⚠️ 注意事项

### 安全性

- ✅ 试运行模式默认开启，不会误删文件
- ✅ 执行清理前需要手动确认
- ✅ 自动备份元数据文件
- ✅ 保留有提示词的图片优先

### 建议

1. **先备份**: 建议先备份 `data/tmp/image` 目录
2. **先试运行**: 使用试运行模式查看将要删除的文件
3. **检查结果**: 确认保留的是正确的文件
4. **执行清理**: 确认无误后再执行实际清理

### 恢复

如果误删了文件：
1. 从备份中恢复图片文件
2. 从备份中恢复 `data/image_metadata.json`

## 📈 清理效果

### 预期效果

- 删除 1012 个重复文件
- 释放 176.77 MB 磁盘空间
- 保留所有有提示词的图片
- 元数据保持一致

### 清理后

系统会显示：
```
[+] 清理完成
  - 已删除文件数: 1012
  - 已释放空间: 176.77 MB
  - 已更新元数据: 1012 条
```

## 🔧 高级选项

### 查看帮助

```bash
python cleanup_duplicates.py --help
```

### 参数说明

- `--clean`: 执行实际清理（默认为试运行）
- `--add-hashes`: 为现有图片添加哈希值
- `--image-dir PATH`: 指定图片目录（默认: data/tmp/image）

## 🐛 故障排除

### 问题1: 编码错误

如果遇到 `UnicodeEncodeError`，这是 Windows 控制台编码问题，已在最新版本中修复。

### 问题2: 元数据不一致

如果元数据文件损坏，工具会自动跳过不存在的文件。

### 问题3: 权限错误

确保有读写权限：
- 图片目录: `data/tmp/image`
- 元数据文件: `data/image_metadata.json`

## 📝 日志

清理过程中的详细日志会输出到控制台，包括：
- 扫描进度
- 重复文件列表
- 保留/删除决策
- 元数据更新状态

## 🎓 示例输出

### 试运行模式

```
[*] 扫描目录: data\tmp\image
================================================================================
[*] 找到 4825 个图片文件

[*] 进度: 100/4825 (2.1%)
...
[+] 扫描完成: 4825/4825 个文件

[!] 发现 1012 组重复图片
================================================================================

[1] 哈希: 716099085c188541... (2 个文件)
  [保留] 00730c1b-49c3-458d-af52-aef7935fce0a.jpg (有提示词)
         大小: 186.0 KB | 时间: 2026-02-09 22:46:48
         提示词: 性感和迷人的女孩，穿着、戴着一个透明的...
  [删除] imagine_1770648408695_2.jpg
         大小: 186.0 KB | 时间: 2026-02-09 22:46:48
         提示词: 导入的: imagine_1770648408695_2

...

================================================================================
[*] 试运行模式 - 未实际删除文件
  - 将删除文件数: 1012
  - 将释放空间: 176.77 MB
```

### 执行清理

```
[*] 开始清理重复图片...
================================================================================
  [+] 已删除: imagine_1770648408695_2.jpg (186.0 KB)
  [+] 已删除: 00ecf479-83e0-4553-b1cf-54b92319b160.jpg (163.5 KB)
  ...

[*] 更新元数据...
  [+] 已从元数据中移除 1012 条记录

================================================================================
[+] 清理完成
  - 已删除文件数: 1012
  - 已释放空间: 176.77 MB
  - 已更新元数据: 1012 条
```

## 🔗 相关功能

### 自动去重（已实现）

新生成的图片会自动进行去重检查：
- 计算 SHA256 哈希值
- 检查是否已存在相同内容
- 跳过重复图片的保存

详见提交: `ed96b79 - feat: 实现图片内容去重机制`

### 导入去重（已实现）

导入图片时会自动检查：
- 计算文件哈希
- 检查是否已导入
- 返回已存在图片的ID

## 📞 支持

如有问题，请检查：
1. Python 版本 >= 3.8
2. 依赖包已安装
3. 有足够的磁盘空间
4. 有读写权限

---

**最后更新**: 2026-02-10
**工具版本**: 1.0.0
