# 图片管理功能 - 使用说明

## 🎯 功能概述

图片管理功能为 Grok2API 提供完整的图片生命周期管理，包括自动元数据保存、图片浏览、筛选排序、批量操作和标签管理。

---

## 🚀 快速开始

### 第一步：启动服务

```bash
cd D:\navy_code\github_code\grok2api
python main.py
```

服务启动后会显示：
```
INFO: Application startup complete.
INFO: Uvicorn running on http://0.0.0.0:8000
```

### 第二步：访问图片管理页面

打开浏览器访问：
```
http://localhost:8000/admin/gallery
```

### 第三步：生成图片

**方式 1：使用 Imagine 页面**
1. 访问 `http://localhost:8000/admin/imagine`
2. 输入提示词，选择宽高比
3. 点击生成，图片会自动保存元数据

**方式 2：使用 API**
```bash
curl -X POST http://localhost:8000/v1/images/generations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{
    "prompt": "美丽的日落海景",
    "model": "grok-imagine-1.0",
    "n": 1
  }'
```

### 第四步：管理图片

在图片管理页面可以：
- 浏览所有生成的图片
- 使用搜索和筛选功能
- 批量导出或删除图片
- 为图片添加标签

---

## 📖 功能详解

### 1. 图片浏览

**网格视图**：
- 卡片式展示，每张图片显示缩略图、提示词、比例和大小
- 鼠标悬停有阴影效果
- 点击图片查看详情

**列表视图**：
- 表格式展示，显示更多信息
- 包含模型、时间等详细信息
- 更紧凑的布局

**切换视图**：点击工具栏的 ⊞ (网格) 或 ☰ (列表) 按钮

### 2. 搜索和筛选

**搜索框**：
- 输入关键词搜索提示词
- 支持模糊匹配
- 按回车或点击"筛选"按钮

**模型筛选**：
- 选择特定的生成模型
- 目前支持 grok-imagine-1.0

**宽高比筛选**：
- 1:1 - 正方形
- 2:3 - 竖版
- 3:2 - 横版
- 9:16 - 手机竖屏
- 16:9 - 手机横屏

**排序方式**：
- 最新优先（默认）
- 最早优先
- 大小降序
- 大小升序

**重置筛选**：点击"重置"按钮清空所有筛选条件

### 3. 批量操作

**选择图片**：
- 勾选图片左上角的复选框
- 点击"全选"按钮选择当前页所有图片
- 可以跨页选择

**批量导出**：
1. 选择要导出的图片
2. 点击"导出"按钮
3. 自动下载 ZIP 文件
4. ZIP 文件包含所有选中的图片

**批量删除**：
1. 选择要删除的图片
2. 点击"删除"按钮
3. 确认删除操作
4. 图片文件和元数据会同时删除

### 4. 图片详情

**查看详情**：
- 点击任意图片卡片
- 弹出详情窗口
- 显示大图和完整元数据

**详情信息**：
- 提示词
- 生成模型
- 宽高比
- 图片尺寸
- 文件大小
- 创建时间
- 标签列表

**操作按钮**：
- 下载：下载原图到本地
- 删除：删除该图片

### 5. 标签管理

**添加标签**：
1. 在图片详情窗口
2. 在"添加标签"输入框输入标签名
3. 按回车或点击"添加"按钮
4. 标签立即保存并显示

**删除标签**：
1. 在标签列表中
2. 点击标签右侧的 × 按钮
3. 标签立即删除

**标签用途**：
- 分类管理图片
- 快速查找相关图片
- 统计常用标签

### 6. 统计信息

页面顶部显示 4 个统计卡片：

**图片总数**：
- 显示所有图片的数量
- 实时更新

**总大小**：
- 显示所有图片占用的存储空间
- 单位自动转换（B/KB/MB/GB）

**本月新增**：
- 显示本月生成的图片数量
- 每月 1 号自动重置

**常用标签**：
- 显示使用最多的前 3 个标签
- 帮助了解图片分类情况

---

## ⚙️ 配置说明

### 存储后端配置

默认使用本地文件存储，数据保存在：
- 图片文件：`data/tmp/image/`
- 元数据：`data/image_metadata.json`

**切换到 Redis**：
```bash
export SERVER_STORAGE_TYPE=redis
export SERVER_STORAGE_URL=redis://localhost:6379/0
```

**切换到 MySQL**：
```bash
export SERVER_STORAGE_TYPE=mysql
export SERVER_STORAGE_URL=mysql://user:password@localhost:3306/grok2api
```

**切换到 PostgreSQL**：
```bash
export SERVER_STORAGE_TYPE=pgsql
export SERVER_STORAGE_URL=postgresql://user:password@localhost:5432/grok2api
```

### 分页大小配置

默认每页显示 50 张图片，修改方法：

编辑 `app/static/gallery/gallery.js`：
```javascript
const state = {
    pageSize: 50,  // 改为需要的数量，如 20 或 100
};
```

---

## 💡 使用技巧

### 技巧 1：快速查找图片
1. 使用搜索框输入关键词
2. 结合模型和比例筛选
3. 按时间排序找到最新的

### 技巧 2：定期清理
1. 按"最早优先"排序
2. 批量选择旧图片
3. 点击删除释放空间

### 技巧 3：标签分类
1. 为图片添加有意义的标签
2. 如：风景、人物、抽象等
3. 方便后续查找和管理

### 技巧 4：批量导出
1. 使用筛选找到需要的图片
2. 全选当前页
3. 翻页继续选择
4. 一次性导出所有选中的

### 技巧 5：查看统计
1. 定期查看统计卡片
2. 了解图片生成情况
3. 根据常用标签优化分类

---

## 🔧 常见问题

### Q1: 页面打不开？
**A**: 
1. 检查服务是否启动：`ps aux | grep python`
2. 检查端口是否被占用：`netstat -ano | findstr :8000`
3. 查看服务日志是否有错误

### Q2: 图片不显示？
**A**: 
1. 确认图片文件存在：`ls data/tmp/image/`
2. 检查文件权限
3. 刷新浏览器页面

### Q3: 元数据没有保存？
**A**: 
1. 检查 `data/` 目录写入权限
2. 查看服务日志：`tail -f logs/app.log`
3. 确认存储服务正常工作

### Q4: 统计信息不准确？
**A**: 
运行清理脚本：
```python
import asyncio
from app.services.gallery.service import get_image_metadata_service

async def cleanup():
    service = get_image_metadata_service()
    count = await service.cleanup_orphaned_metadata()
    print(f"清理了 {count} 条孤立元数据")

asyncio.run(cleanup())
```

### Q5: 如何备份图片？
**A**: 
1. 使用批量导出功能导出 ZIP
2. 或直接复制 `data/tmp/image/` 目录
3. 同时备份 `data/image_metadata.json`

### Q6: 如何恢复图片？
**A**: 
1. 将图片文件复制到 `data/tmp/image/`
2. 恢复 `data/image_metadata.json`
3. 重启服务

---

## 📊 性能优化

### 大量图片时的优化建议

**1. 使用 Redis 存储**：
```bash
export SERVER_STORAGE_TYPE=redis
export SERVER_STORAGE_URL=redis://localhost:6379/0
```
- 提升读写性能
- 支持分布式部署

**2. 定期清理**：
- 每月清理不需要的图片
- 释放存储空间
- 保持系统性能

**3. 调整分页大小**：
- 图片多时减小分页大小（如 20）
- 图片少时增大分页大小（如 100）
- 根据实际情况调整

**4. 使用标签分类**：
- 合理使用标签
- 避免创建过多标签
- 定期整理标签

---

## 📞 获取帮助

**查看文档**：
- `README_图片管理.md` - 项目总结
- `docs/图片管理功能.md` - 详细技术文档
- `使用说明.md` - 本文档

**运行测试**：
```bash
python test_gallery.py
```

**查看日志**：
```bash
tail -f logs/app.log
```

**提交问题**：
https://github.com/chenyme/grok2api/issues

---

## 🎉 开始使用

现在您已经了解了图片管理功能的所有使用方法，可以开始使用了！

```bash
# 启动服务
python main.py

# 访问页面
# http://localhost:8000/admin/gallery
```

祝使用愉快！🚀

---

*最后更新：2026-02-07*
