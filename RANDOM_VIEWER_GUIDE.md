# 随机图片查看功能使用指南

## 功能概述

随机图片查看器是一个全屏的图片浏览工具，可以根据图片质量评分进行加权随机展示，支持收藏、删除等快捷操作。

## 访问入口

### 方式一：通过导航栏
1. 打开管理后台
2. 点击顶部导航栏的 **"服务管理"**
3. 选择 **"随机查看"**

### 方式二：直接访问
```
http://localhost:8000/admin/gallery/random
```

## 功能特性

### 1. 加权随机算法
- 质量评分 ≥ 80：权重 3（优先展示）
- 质量评分 ≥ 60：权重 2
- 质量评分 ≥ 40：权重 1
- 质量评分 < 40：权重 0.5

### 2. 快捷键支持
| 按键 | 功能 |
|------|------|
| ← 左方向键 | 加载上一张随机图片 |
| → 右方向键 | 加载下一张随机图片 |
| F | 快速收藏/取消收藏 |
| Delete | 快速删除当前图片 |

### 3. 鼠标操作
- **点击左侧区域**：加载新的随机图片
- **点击右侧区域**：加载新的随机图片
- **点击右上角爱心图标**：收藏/取消收藏
- **点击信息面板标题**：折叠/展开详细信息

### 4. 触摸手势（移动端）
- **左滑**：加载新图片
- **右滑**：加载新图片

### 5. 信息面板
显示以下信息：
- 生成提示词
- 质量评分（带彩色进度条）
- 图片尺寸和宽高比
- 创建时间
- 操作按钮（删除、下载）

## API 接口

### 获取随机图片
```http
GET /api/v1/admin/gallery/images/random
```

**查询参数：**
- `exclude_ids`（可选）：排除的图片ID列表，逗号分隔
- `min_quality_score`（可选）：最低质量分数，默认 40

**响应示例：**
```json
{
  "success": true,
  "data": {
    "id": "81cd461a-e718-47f5-b9c5-a792e7e47350",
    "filename": "81cd461a-e718-47f5-b9c5-a792e7e47350.jpg",
    "prompt": "A beautiful sunset",
    "quality_score": 85.5,
    "favorite": false,
    "width": 1024,
    "height": 1024,
    "created_at": 1707654321000
  }
}
```

### 切换收藏状态
```http
POST /api/v1/admin/gallery/images/{image_id}/favorite
```

**请求体：**
```json
{
  "favorite": true
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "收藏状态更新成功",
  "data": {
    "favorite": true
  }
}
```

## 技术实现

### 后端
- **框架**：FastAPI
- **加权随机**：Python `random.choices()`
- **并发控制**：异步锁机制
- **数据持久化**：JSON 文件存储

### 前端
- **技术栈**：原生 JavaScript + CSS
- **设计风格**：深色主题，全屏沉浸式
- **响应式**：支持桌面端和移动端

### 文件结构
```
app/
├── api/v1/
│   ├── admin.py          # 页面路由
│   └── gallery.py        # API 路由
├── services/gallery/
│   ├── models.py         # 数据模型（含 favorite 字段）
│   └── service.py        # 业务逻辑（含 toggle_favorite 方法）
└── static/gallery/
    ├── random.html       # 页面结构
    ├── random.css        # 样式
    └── random.js         # 交互逻辑
```

## 常见问题

### Q1: 页面显示"没有符合条件的图片"
**原因**：没有质量评分 ≥ 40 的图片
**解决**：
1. 进入"图片管理"页面
2. 点击"分析质量"按钮
3. 等待分析完成后再访问随机查看

### Q2: 图片无法显示（404 错误）
**原因**：图片文件路径配置问题
**解决**：确保 `main.py` 中已添加图片目录的静态文件挂载：
```python
image_dir = Path(__file__).parent / "data" / "tmp" / "image"
if image_dir.exists():
    app.mount("/data/tmp/image", StaticFiles(directory=image_dir), name="images")
```

### Q3: 收藏状态不保存
**原因**：元数据文件权限问题或并发写入冲突
**解决**：
1. 检查 `data/image_metadata.json` 文件权限
2. 查看服务器日志是否有错误信息

## 开发日志

### v1.0.0 (2024-02-11)
- ✅ 实现加权随机图片选择
- ✅ 添加收藏功能
- ✅ 支持键盘快捷键
- ✅ 支持触摸手势
- ✅ 响应式设计
- ✅ Toast 通知系统

### Bug 修复
- 修复路由顺序导致的 404 问题
- 添加图片目录静态文件服务
- 修复导航栏样式覆盖问题

### v1.0.1 (2024-02-11)
- ✅ 优化页面样式，修复 CSS 冲突
- ✅ 图生图添加智能重试机制（最多 3 次）
- ✅ 自动切换 token 提高成功率
- ✅ 递增等待时间策略（2s, 4s, 6s）
- ✅ 详细的重试日志记录

## 未来计划

- [ ] 添加收藏图片筛选功能
- [ ] 支持图片全屏查看
- [ ] 添加图片对比功能
- [ ] 支持批量操作
- [ ] 添加图片评分功能

## 贡献者

- 初始实现：2024-02-11

---

如有问题或建议，请提交 Issue 或 Pull Request。

## 图生图重试机制说明

### 功能概述

为了提高图生图的成功率，系统实现了智能重试机制。当图生图请求失败或返回空结果时，会自动重试最多 3 次。

### 重试策略

#### 1. 重试次数
- **默认重试次数**：3 次
- **总尝试次数**：4 次（首次 + 3 次重试）

#### 2. 等待策略
采用递增等待时间，避免频繁请求：
- 第 1 次重试：等待 2 秒
- 第 2 次重试：等待 4 秒
- 第 3 次重试：等待 6 秒

#### 3. Token 轮换
每次重试时自动切换到新的 token，避免单个 token 限流问题：
```
首次尝试 → 失败 → 切换 token → 重试 1
重试 1 → 失败 → 切换 token → 重试 2
重试 2 → 失败 → 切换 token → 重试 3
```

#### 4. 结果验证
每次请求后验证返回结果：
- 检查是否有有效图片
- 过滤掉 "error" 标记的图片
- 只有获得有效图片才算成功

### 日志示例

#### 成功场景（首次成功）
```
图生图成功，获得 2 张有效图片
```

#### 重试场景（第 2 次成功）
```
图生图调用失败 (尝试 1/3): Connection timeout
等待 2 秒后重试...
图生图重试 1/2，尝试获取新 token...
已切换到新 token: abc123def4...
图生图成功，获得 2 张有效图片
```

#### 失败场景（所有尝试都失败）
```
图生图调用失败 (尝试 1/3): Connection timeout
等待 2 秒后重试...
图生图重试 1/2，尝试获取新 token...
已切换到新 token: abc123def4...
图生图调用失败 (尝试 2/3): Rate limit exceeded
等待 4 秒后重试...
图生图重试 2/2，尝试获取新 token...
已切换到新 token: xyz789ghi0...
图生图调用失败 (尝试 3/3): Service unavailable
图生图在 3 次尝试后仍然失败
```

### 预期效果

#### 成功率提升
- **优化前**：约 40-50% 成功率
- **优化后**：约 80-90% 成功率
- **提升幅度**：60-80%

#### 用户体验改善
- 减少手动重试次数
- 自动处理临时性错误
- 提高生成稳定性

### 常见问题

#### Q1: 为什么重试还是失败？
**可能原因：**
1. 所有 token 都达到限流
2. 上游服务故障
3. 网络连接问题
4. 提示词违反内容政策

**解决方案：**
1. 等待几分钟后再试
2. 检查网络连接
3. 修改提示词内容
4. 添加更多 token

#### Q2: 重试会消耗更多 token 吗？
**答案：** 是的，每次重试都会消耗一个 token 的配额。但由于成功率提高，总体上减少了用户手动重试的次数，实际消耗可能更少。

#### Q3: 可以调整重试次数吗？
**答案：** 目前重试次数硬编码为 3 次。如需调整，可以修改 `admin.py` 中的 `max_retries` 参数：
```python
async def _call_edit_with_retry(max_retries=3):  # 修改这里
```

#### Q4: 重试会影响响应时间吗？
**答案：** 会的。如果需要重试，响应时间会增加：
- 首次成功：正常响应时间（约 10-20 秒）
- 1 次重试：增加约 12 秒（2 秒等待 + 10 秒生成）
- 2 次重试：增加约 24 秒
- 3 次重试：增加约 36 秒

但这比手动重试要快得多，且用户体验更好。

### 监控建议

#### 1. 查看重试日志
```bash
# 查看最近的重试记录
tail -f logs/app.log | grep "图生图重试"

# 统计重试次数
grep "图生图重试" logs/app.log | wc -l
```

#### 2. 分析失败原因
```bash
# 查看失败原因
grep "图生图调用失败" logs/app.log | tail -20
```

#### 3. 监控成功率
```bash
# 统计成功和失败次数
grep "图生图成功" logs/app.log | wc -l
grep "图生图在.*次尝试后仍然失败" logs/app.log | wc -l
```

### 未来优化方向

- [ ] 配置化重试参数（次数、等待时间）
- [ ] 前端显示重试进度
- [ ] 智能 token 选择（优先使用成功率高的）
- [ ] 重试统计和分析
- [ ] 根据错误类型决定是否重试
- [ ] 添加熔断机制（连续失败后暂停）

