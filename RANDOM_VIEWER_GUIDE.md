# 随机图片查看功能使用指南

## 功能概述

随机图片查看器是一个全屏的图片浏览工具，可以根据图片质量评分进行加权随机展示，支持收藏、删除等快捷操作。

## 访问入口

### 方式一：通过导航栏
1. 打开管理后台
2. 点击顶部导航栏的 **"服务管理"**
3. 选择 **"随机查看"**

### 方式二：直接访问
```
http://localhost:8000/admin/gallery/random
```

## 功能特性

### 1. 加权随机算法
- 质量评分 ≥ 80：权重 3（优先展示）
- 质量评分 ≥ 60：权重 2
- 质量评分 ≥ 40：权重 1
- 质量评分 < 40：权重 0.5

### 2. 快捷键支持
| 按键 | 功能 |
|------|------|
| ← 左方向键 | 加载上一张随机图片 |
| → 右方向键 | 加载下一张随机图片 |
| F | 快速收藏/取消收藏 |
| Delete | 快速删除当前图片 |

### 3. 鼠标操作
- **点击左侧区域**：加载新的随机图片
- **点击右侧区域**：加载新的随机图片
- **点击右上角爱心图标**：收藏/取消收藏
- **点击信息面板标题**：折叠/展开详细信息

### 4. 触摸手势（移动端）
- **左滑**：加载新图片
- **右滑**：加载新图片

### 5. 信息面板
显示以下信息：
- 生成提示词
- 质量评分（带彩色进度条）
- 图片尺寸和宽高比
- 创建时间
- 操作按钮（删除、下载）

## API 接口

### 获取随机图片
```http
GET /api/v1/admin/gallery/images/random
```

**查询参数：**
- `exclude_ids`（可选）：排除的图片ID列表，逗号分隔
- `min_quality_score`（可选）：最低质量分数，默认 40

**响应示例：**
```json
{
  "success": true,
  "data": {
    "id": "81cd461a-e718-47f5-b9c5-a792e7e47350",
    "filename": "81cd461a-e718-47f5-b9c5-a792e7e47350.jpg",
    "prompt": "A beautiful sunset",
    "quality_score": 85.5,
    "favorite": false,
    "width": 1024,
    "height": 1024,
    "created_at": 1707654321000
  }
}
```

### 切换收藏状态
```http
POST /api/v1/admin/gallery/images/{image_id}/favorite
```

**请求体：**
```json
{
  "favorite": true
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "收藏状态更新成功",
  "data": {
    "favorite": true
  }
}
```

## 技术实现

### 后端
- **框架**：FastAPI
- **加权随机**：Python `random.choices()`
- **并发控制**：异步锁机制
- **数据持久化**：JSON 文件存储

### 前端
- **技术栈**：原生 JavaScript + CSS
- **设计风格**：深色主题，全屏沉浸式
- **响应式**：支持桌面端和移动端

### 文件结构
```
app/
├── api/v1/
│   ├── admin.py          # 页面路由
│   └── gallery.py        # API 路由
├── services/gallery/
│   ├── models.py         # 数据模型（含 favorite 字段）
│   └── service.py        # 业务逻辑（含 toggle_favorite 方法）
└── static/gallery/
    ├── random.html       # 页面结构
    ├── random.css        # 样式
    └── random.js         # 交互逻辑
```

## 常见问题

### Q1: 页面显示"没有符合条件的图片"
**原因**：没有质量评分 ≥ 40 的图片
**解决**：
1. 进入"图片管理"页面
2. 点击"分析质量"按钮
3. 等待分析完成后再访问随机查看

### Q2: 图片无法显示（404 错误）
**原因**：图片文件路径配置问题
**解决**：确保 `main.py` 中已添加图片目录的静态文件挂载：
```python
image_dir = Path(__file__).parent / "data" / "tmp" / "image"
if image_dir.exists():
    app.mount("/data/tmp/image", StaticFiles(directory=image_dir), name="images")
```

### Q3: 收藏状态不保存
**原因**：元数据文件权限问题或并发写入冲突
**解决**：
1. 检查 `data/image_metadata.json` 文件权限
2. 查看服务器日志是否有错误信息

## 开发日志

### v1.0.0 (2024-02-11)
- ✅ 实现加权随机图片选择
- ✅ 添加收藏功能
- ✅ 支持键盘快捷键
- ✅ 支持触摸手势
- ✅ 响应式设计
- ✅ Toast 通知系统

### Bug 修复
- 修复路由顺序导致的 404 问题
- 添加图片目录静态文件服务

## 未来计划

- [ ] 添加收藏图片筛选功能
- [ ] 支持图片全屏查看
- [ ] 添加图片对比功能
- [ ] 支持批量操作
- [ ] 添加图片评分功能

## 贡献者

- 初始实现：2024-02-11

---

如有问题或建议，请提交 Issue 或 Pull Request。
